== Predeployment steps

*Prerequisites*

Ensure you have the following tools installed:

* https://git-scm.com/book/en/v2/Getting-Started-Installing-Git[Git] - To clone the repository
* http://pip.pypa.io/en/stable/installation/[Python/pip] - Required for taskcat installation
* https://docs.docker.com/get-started/get-docker/[Docker] - For packaging Lambda functions
* https://aws-ia.github.io/taskcat/docs/INSTALLATION/[taskcat] - Install using: `pip install taskcat`

[source,bash]
----
# Clone the repository
git clone https://github.com/awslabs/cfn-ecr-aws-soci-index-builder.git
cd cfn-ecr-aws-soci-index-builder

# Verify Docker is running
docker info
----

*Configuration and Upload*

We will use https://aws-ia.github.io/taskcat/[taskcat] tool to package and upload the code artifacts.

[TIP]
====
The taskcat.yml file must be updated with the correct regions where you want to deploy your stack. This is crucial as the template will be built specifically for those regions.
====

** Example `taskcat.yml` configuration
+
[source, yaml]
----
project:
  name: cfn-ecr-aws-soci-index-builder
  owner: quickstart@amazon.com
  s3_regional_buckets: true
  lambda_source_path: functions/source
  lambda_zip_path: functions/packages
  parameters:
    QSS3BucketName: $[taskcat_autobucket]
    QSS3KeyPrefix: "cfn-ecr-aws-soci-index-builder/"
tests:
  can-deploy:
    parameters:
      SociRepositoryImageTagFilters: "*:*"
    regions:
      - us-east-1      # US East (N. Virginia)
      - eu-west-1      # Europe (Ireland)
      - us-west-1      # US West (N. California)
      # Add or remove regions as needed
    template: templates/SociIndexBuilder.yml
----
+

** For AWS GovCloud deployment, update the regions section:
+
[source, yaml]
----
    regions:
      - us-gov-west-1  # AWS GovCloud (US-West)
      - us-gov-east-1  # AWS GovCloud (US-East)
----
+
.


** For China Region deployment, update the regions section:
+
[source,yaml]
----
    regions:
      - cn-north-1     # China (Beijing)
      - cn-northwest-1 # China (Ningxia)
----

[TIP]
====
Before proceeding with the actual deployment, you can run `taskcat upload --dry-run` to safely preview the resources that will be provisioned. This command simulates the upload process without making any actual changes, helping you verify your configuration.

image::../docs/deployment_guide/images/taskcat_dry_run.png[Taskcat dry-run example]
====

After configuring the taskcat.yml file, run `taskcat upload` from the root directory of the repository.

The upload command will:

* Read the configuration from `.taskcat.yml` file
* Package the lambda functions using the provided Dockerfile (this is why Docker is required)
* Create S3 buckets in all specified regions with the naming pattern `taskcat-cfn-ecr-aws-soci-index-builder-<account-hash>-<region>`
* Upload the CloudFormation template and Lambda packages to these buckets with the prefix `cfn-ecr-aws-soci-index-builder/`
* Make the CloudFormation template available at the URL pattern `https://<bucket-name>.s3.<region>.amazonaws.com/cfn-ecr-aws-soci-index-builder/templates/SociIndexBuilder.yml`

.Example of taskcat upload command output
image::../docs/deployment_guide/images/taskcat_upload.png[Taskcat upload output example]

[NOTE]
====
In the above example you're deploying to the us-east-2 region, the S3 bucket name created is:
`tcat-318317e4bf395d3fa89e1d675d64f43e-us-east-2`
====

After the upload completes:

1. Verify your deployment - Find your S3 bucket (starts with `tcat-`) in the AWS Console
+
image::../docs/deployment_guide/images/verify_S3.png[Verify S3 bucket contents]

2. Locate the template at `cfn-ecr-aws-soci-index-builder/templates/SociIndexBuilder.yml`

3. Copy the Object URL:
+
image::../docs/deployment_guide/images/object_url.png[Object URL location]
[TIP]
====
You can also construct the template URL using this pattern:
`https://<bucket-name>.s3.<region>.amazonaws.com/cfn-ecr-aws-soci-index-builder/templates/SociIndexBuilder.yml`

Replace `<bucket-name>` with your S3 bucket name (starting with `tcat-`) and `<region>` with your deployment region.
====
